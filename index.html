<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tax Tool!</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#000;color:#fff;line-height:1.6;padding:20px;position:relative}
@media(min-width:768px){body{padding:40px}}
.signature{position:fixed;bottom:10px;right:10px;color:#666;font-size:10px}
@media(min-width:768px){.signature{bottom:20px;right:20px;font-size:12px}}
.container{max-width:700px;margin:0 auto}
.step{margin-bottom:40px}
h1{font-size:18px;margin-bottom:20px;font-weight:normal;color:#fff}
.description{color:#fff;margin-bottom:30px;font-size:14px;line-height:1.8}
.btn{background:#fff;color:#000;border:none;padding:10px 20px;font-family:'Inter',sans-serif;font-size:14px;cursor:pointer;margin-right:10px;margin-top:10px;width:100%}
@media(min-width:600px){.btn{width:auto}}
.btn:hover{background:#ddd}
.btn:disabled{opacity:.3;cursor:not-allowed}
.btn-secondary{background:transparent;color:#fff;border:1px solid #fff}
.btn-secondary:hover{background:#fff;color:#000}
.input-group{margin-bottom:20px}
.input-group label{display:block;margin-bottom:8px;font-size:13px;color:#999}
select,textarea{width:100%;padding:10px;background:#111;border:1px solid #333;color:#fff;font-family:'Inter',sans-serif;font-size:14px}
select:focus,textarea:focus{outline:none;border-color:#fff}
.upload-zone{border:1px solid #333;padding:40px;text-align:center;cursor:pointer;margin-top:20px}
.upload-zone:hover{border-color:#fff}
.upload-zone input{display:none}
.file-list{margin-top:20px;font-size:13px}
.file-item{padding:10px;background:#111;margin-bottom:5px;border-left:2px solid #fff;display:flex;justify-content:space-between}
.transaction-card{background:#111;padding:20px;margin-bottom:15px}
.transaction-card.flagged{border:1px solid #333}
.transaction-header{display:flex;flex-direction:column;gap:10px;margin-bottom:10px}
@media(min-width:600px){.transaction-header{flex-direction:row;justify-content:space-between;gap:0}}
.transaction-amount{font-size:18px;font-weight:bold}
.transaction-question{margin:15px 0;padding:15px;background:#000;border:1px solid #333}
.radio-group{display:flex;flex-direction:column;gap:10px;margin-top:10px}
@media(min-width:600px){.radio-group{flex-direction:row;gap:20px}}
.radio-group label{display:flex;align-items:center;gap:8px;cursor:pointer}
.checkbox-group{margin-top:10px;font-size:13px;color:#999}
.summary-box{background:#111;padding:30px;margin-top:30px;border:1px solid #333}
.summary-grid{display:grid;grid-template-columns:1fr;gap:15px;margin-top:20px}
@media(min-width:600px){.summary-grid{grid-template-columns:repeat(2,1fr);gap:20px}}
.summary-item{padding:15px;background:#000}
.summary-label{font-size:11px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:5px}
.summary-value{font-size:24px}
.hidden{display:none}
.progress-bar{display:none}
.month-section{margin-bottom:40px;padding:20px;background:#111;border-left:3px solid #fff}
.month-header{font-size:14px;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #333}
.info-box{background:#111;border:1px solid #333;padding:15px;margin-top:20px;font-size:12px;color:#999}
</style>
</head>
<body>
<div class="container">
<div id="step1" class="step">
<h1>Tax Deductions for Creatives</h1>
<p class="description">Tool built to simplify the tax process for creatives. Input all the information as specifically as possible to make things easier and more accurate.</p>
<div class="input-group">
<label>What type of creative work do you do? (Select all that apply)</label>
<div style="background:#111;border:1px solid #333;padding:15px;max-width:400px">
<label style="display:block;margin-bottom:8px;cursor:pointer"><input type="checkbox" class="creative-checkbox" value="photographer"> Photographer</label>
<label style="display:block;margin-bottom:8px;cursor:pointer"><input type="checkbox" class="creative-checkbox" value="designer"> Graphic Designer</label>
<label style="display:block;margin-bottom:8px;cursor:pointer"><input type="checkbox" class="creative-checkbox" value="writer"> Writer / Copywriter</label>
<label style="display:block;margin-bottom:8px;cursor:pointer"><input type="checkbox" class="creative-checkbox" value="filmmaker"> Filmmaker / Video Producer</label>
<label style="display:block;margin-bottom:8px;cursor:pointer"><input type="checkbox" class="creative-checkbox" value="illustrator"> Illustrator</label>
<label style="display:block;margin-bottom:8px;cursor:pointer"><input type="checkbox" class="creative-checkbox" value="web-dev"> Web Developer</label>
<label style="display:block;margin-bottom:8px;cursor:pointer"><input type="checkbox" class="creative-checkbox" value="musician"> Musician / Audio Producer</label>
<label style="display:block;margin-bottom:0;cursor:pointer"><input type="checkbox" class="creative-checkbox" value="other"> Other Creative Professional</label>
</div>
</div>
<div class="input-group">
<label>Business structure</label>
<select id="businessStructure">
<option value="">Select...</option>
<option value="sole-proprietor">Sole Proprietor - You own the business, report on Schedule C</option>
<option value="llc">LLC - Limited liability company, separate legal entity</option>
<option value="s-corp">S-Corp - Corporation with pass-through taxation</option>
<option value="freelancer">Freelancer / 1099 - Independent contractor receiving 1099 forms</option>
</select>
</div>
<div class="input-group">
<label>Do you have a dedicated home office space?</label>
<select id="homeOffice">
<option value="">Select...</option>
<option value="yes">Yes, dedicated space</option>
<option value="partial">Sometimes work from home</option>
<option value="no">No home office</option>
</select>
</div>
<div class="input-group">
<label>How often do you meet clients for meals/coffee?</label>
<select id="clientMeals">
<option value="">Select...</option>
<option value="frequent">Frequently (weekly)</option>
<option value="occasional">Occasionally (monthly)</option>
<option value="rare">Rarely</option>
<option value="never">Never</option>
</select>
</div>
<button class="btn" onclick="completeOnboarding()">Continue</button>
</div>
<div id="step2" class="step hidden">
<h1>Upload Your Bank Statements</h1>
<p style="color:#999;margin-bottom:20px;font-size:14px">CSV or PDF format.</p>
<div class="info-box"><strong>How to get your statements:</strong><br>• CSV: Most banks let you download transactions as CSV<br>• PDF: Upload your bank statement PDFs directly</div>
<div style="margin-top:30px;margin-bottom:20px">
<label style="display:block;margin-bottom:8px;font-size:13px;color:#999">Add custom rules (optional)</label>
<textarea id="customRules" placeholder="Example: RedFin Coffee is always work related. Don't ask about grocery stores. Always ask about dinners." style="width:100%;max-width:600px;min-height:100px;padding:12px;background:#111;border:1px solid #333;color:#fff;font-family:'Times New Roman',serif;font-size:14px;resize:vertical"></textarea>
<div style="font-size:12px;color:#666;margin-top:8px">Tell the tool about patterns in your spending so it knows what to auto-approve or always ask about.</div>
</div>
<div class="upload-zone" onclick="document.getElementById('fileInput').click()">
<div style="font-size:40px;margin-bottom:15px">[ ]</div>
<div>Click to select CSV or PDF files</div>
<div style="margin-top:10px;color:#666;font-size:12px">Select multiple files for all months.</div>
<input type="file" id="fileInput" accept=".csv,.pdf" multiple>
</div>
<div id="fileList" class="file-list"></div>
<button class="btn hidden" id="processBtn" onclick="processFiles()">Process Statements</button>
</div>
<div id="step3" class="step hidden">
<h1>Review Flagged Transactions</h1>
<p style="color:#999;margin-bottom:20px;font-size:14px">Refer to your statement for accuracy.</p>
<div class="progress-bar"><div class="progress-fill" id="reviewProgress" style="width:0%"></div></div>
<div id="transactionsList"></div>
<button class="btn hidden" id="finishBtn" onclick="generateReport()">Generate Report</button>
</div>
<div id="step4" class="step hidden">
<h1>Your Tax Deduction Summary</h1>
<p style="color:#999;margin-bottom:20px;font-size:14px">Organized by month and category.</p>
<div class="summary-box">
<div class="summary-grid">
<div class="summary-item"><div class="summary-label">Total Deductible</div><div class="summary-value" id="totalDeductible">$0.00</div></div>
<div class="summary-item"><div class="summary-label">Transactions Reviewed</div><div class="summary-value" id="totalTransactions">0</div></div>
<div class="summary-item"><div class="summary-label">Estimated Tax Savings</div><div class="summary-value" id="estimatedSavings">$0.00</div><div style="font-size:11px;color:#666;margin-top:5px">@ 25% rate</div></div>
<div class="summary-item"><div class="summary-label">Months Covered</div><div class="summary-value" id="monthsCovered">0</div></div>
</div>
</div>
<div id="recurringSection"></div>
<div id="monthlyBreakdown" style="margin-top:40px"></div>
<div style="margin-top:40px">
<button class="btn" onclick="downloadReport()">Download Full Report (CSV)</button>
<button class="btn" onclick="downloadMonthly()">Download by Month (ZIP)</button>
<button class="btn-secondary btn" onclick="resetTool()">Start Over</button>
</div>
</div>
</div>
<div class="signature">NW</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
let userProfile={},uploadedFiles=[],allTransactions=[],flaggedTransactions=[],currentReviewIndex=0,learnedPatterns={};
const IRS_CATEGORIES={software:['adobe','microsoft','canva','figma','sketch','procreate','affinity','notion'],equipment:['b&h','adorama','apple','best buy','camera','lens','microphone'],travel:['delta','united','american airlines','jetblue','southwest','hotel','airbnb','uber','lyft'],supplies:['staples','office depot','amazon'],meals:['starbucks','coffee','restaurant','chipotle','panera']};

function completeOnboarding(){
  const t=Array.from(document.querySelectorAll('.creative-checkbox:checked')).map(e=>e.value);
  if(userProfile={creativeType:t,businessStructure:document.getElementById('businessStructure').value,homeOffice:document.getElementById('homeOffice').value,clientMeals:document.getElementById('clientMeals').value},0===t.length||!userProfile.businessStructure)return void alert('Please complete all required fields');
  document.getElementById('step1').classList.add('hidden');
  document.getElementById('step2').classList.remove('hidden');
}

document.getElementById('fileInput').addEventListener('change',function(e){
  uploadedFiles=Array.from(e.target.files);
  const t=document.getElementById('fileList');
  t.innerHTML='<div style="margin-top:20px;color:#999">Files selected:</div>';
  uploadedFiles.forEach(e=>{
    const a=document.createElement('div');
    a.className='file-item';
    a.innerHTML='<span>'+e.name+'</span><span style="color:#666">'+(e.size/1024).toFixed(1)+' KB</span>';
    t.appendChild(a);
  });
  document.getElementById('processBtn').classList.remove('hidden');
});

async function processFiles(){
  allTransactions=[];
  const customRulesText=document.getElementById('customRules').value;
  parseCustomRules(customRulesText);
  for(const e of uploadedFiles){
    if(e.name.endsWith('.pdf')){
      await parsePDF(e);
    }else{
      await parseCSV(e);
    }
  }
  categorizeTransactions();
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step3').classList.remove('hidden');
  renderFlaggedTransactions();
}

function parseCustomRules(text){
  if(!text.trim())return;
  const lines=text.toLowerCase().split(/[.\n]+/).filter(l=>l.trim());
  lines.forEach(line=>{
    if(line.includes('always work')||line.includes('work related')||line.includes('always deduct')){
      const match=line.match(/(\w+(?:\s+\w+)*)\s+is\s+always|all\s+(?:of\s+the\s+)?(\w+(?:\s+\w+)*)/);
      if(match){
        const merchant=(match[1]||match[2]).trim();
        learnedPatterns[merchant]=true;
      }
    }else if(line.includes("don't ask")||line.includes('never ask')||line.includes('skip')){
      const match=line.match(/about\s+(\w+(?:\s+\w+)*)/);
      if(match){
        const keyword=match[1].trim();
        if(!window.skipKeywords)window.skipKeywords=[];
        window.skipKeywords.push(keyword);
      }
    }else if(line.includes('always ask')){
      const match=line.match(/about\s+(\w+(?:\s+\w+)*)/);
      if(match){
        const keyword=match[1].trim();
        if(!window.alwaysAskKeywords)window.alwaysAskKeywords=[];
        window.alwaysAskKeywords.push(keyword);
      }
    }
  });
}

async function parsePDF(e){
  const t=await e.arrayBuffer();
  const a=await pdfjsLib.getDocument({data:t,standardFontDataUrl:'https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/standard_fonts/',verbosity:0}).promise;
  let n=[];
  for(let e=1;e<=a.numPages;e++){
    const t=await a.getPage(e);
    const r=(await t.getTextContent()).items.map(e=>({text:e.str,x:e.transform[4],y:e.transform[5]}));
    const s={};
    r.forEach(e=>{
      const t=Math.round(e.y);
      if(!s[t])s[t]=[];
      s[t].push(e);
    });
    Object.keys(s).sort((e,t)=>t-e).forEach(e=>{
      n.push(s[e].sort((e,t)=>e.x-t.x).map(e=>e.text).join(' '));
    });
  }
  parseTransactionsFromText(n.join('\n'),e.name);
}

function parseTransactionsFromText(e,t){
  e.split('\n').filter(e=>e.trim().length>10).forEach((e,a)=>{
    const n=e.match(/(\w{3}\s+\d{1,2}|\d{1,2}\/\d{1,2})\s+(.+?)\s+([-]?\d{1,3}(?:,\d{3})*\.\d{2})\s+([-]?\d{1,3}(?:,\d{3})*\.\d{2})\s*$/);
    if(n){
      const r=n[1];
      const s=n[2];
      const d=n[3];
      const l=Math.abs(parseFloat(d.replace(/[$,\s-]/g,'')));
      if(l>0&&s.length>2){
        const e=new Date();
        const n=new Date(r+' '+e.getFullYear());
        if(n>e)n.setFullYear(e.getFullYear()-1);
        allTransactions.push({
          id:t+'_'+a,
          date:n.toLocaleDateString(),
          month:n.toLocaleString('default',{month:'long',year:'numeric'}),
          merchant:s.trim(),
          amount:l,
          category:'uncategorized',
          isDeductible:false,
          autoClassified:false
        });
      }
    }
  });
}

async function parseCSV(e){
  await new Promise((t,a)=>{
    Papa.parse(e,{
      header:true,
      skipEmptyLines:true,
      complete:function(a){
        a.data.forEach((a,n)=>{
          const r=Object.keys(a);
          const s=r.find(e=>e.toLowerCase().includes('date'))||r[0];
          const d=r.find(e=>e.toLowerCase().includes('desc')||e.toLowerCase().includes('memo'))||r[1];
          const i=parseFloat(String(a[r.find(e=>e.toLowerCase().includes('amount'))||r[2]]).replace(/[^0-9.-]/g,''));
          if(!isNaN(i)){
            const r=new Date(a[s]);
            allTransactions.push({
              id:e.name+'_'+n,
              date:a[s],
              month:r.toLocaleString('default',{month:'long',year:'numeric'}),
              merchant:a[d]||'Unknown',
              amount:Math.abs(i),
              category:'uncategorized',
              isDeductible:false,
              autoClassified:false
            });
          }
        });
        t();
      },
      error:a
    });
  });
}

function categorizeTransactions(){
  allTransactions.forEach(e=>{
    const t=e.merchant.toLowerCase();
    if(window.skipKeywords&&window.skipKeywords.some(k=>t.includes(k))){
      e.category='personal';
      e.isDeductible=false;
      e.autoClassified=true;
      return;
    }
    if(window.alwaysAskKeywords&&window.alwaysAskKeywords.some(k=>t.includes(k))){
      e.category='ambiguous-custom';
      flaggedTransactions.push(e);
      return;
    }
    for(const[a,n]of Object.entries(IRS_CATEGORIES)){
      if(n.some(e=>t.includes(e))){
        if(a==='meals'){
          e.category='ambiguous-meal';
          flaggedTransactions.push(e);
          return;
        }else if(a==='supplies'){
          e.category='ambiguous-supplies';
          flaggedTransactions.push(e);
          return;
        }else{
          e.category=a;
          e.isDeductible=true;
          e.autoClassified=true;
          return;
        }
      }
    }
    if(learnedPatterns[e.merchant]!==undefined){
      e.isDeductible=learnedPatterns[e.merchant];
      e.category='learned';
      e.autoClassified=true;
    }
  });
}

function renderFlaggedTransactions(){
  const e=document.getElementById('transactionsList');
  e.innerHTML='';
  if(currentReviewIndex>=flaggedTransactions.length){
    document.getElementById('finishBtn').classList.remove('hidden');
    e.innerHTML='<div style="padding:40px;text-align:center;color:#666">All ambiguous transactions reviewed!</div>';
    return;
  }
  const t=flaggedTransactions[currentReviewIndex];
  const a=document.createElement('div');
  a.className='transaction-card flagged';
  let n='';
  if(t.category==='ambiguous-meal'){
    n='Was this a client meeting or business meal? (50% deductible if yes)';
  }else if(t.category==='ambiguous-supplies'){
    n='Did you purchase office/work supplies here?';
  }else if(t.category==='ambiguous-custom'){
    n='Is this transaction work-related?';
  }
  a.innerHTML='<div class="transaction-header"><div><div style="font-size:14px;color:#999">'+t.date+' • '+t.month+'</div><div style="font-size:18px;margin-top:5px">'+t.merchant+'</div></div><div class="transaction-amount">$'+t.amount.toFixed(2)+'</div></div><div class="transaction-question"><div style="margin-bottom:10px">'+n+'</div><div class="radio-group"><label><input type="radio" name="deductible_'+currentReviewIndex+'" value="yes"> Yes, deductible</label><label><input type="radio" name="deductible_'+currentReviewIndex+'" value="no"> No, personal</label></div><div class="checkbox-group" id="learn_'+currentReviewIndex+'" style="display:none;margin-top:15px"><label><input type="checkbox" id="remember_'+currentReviewIndex+'"> Remember this for future '+t.merchant+' transactions</label></div></div><button class="btn" onclick="submitReview()" style="margin-top:15px">Next</button>';
  e.appendChild(a);
  document.querySelectorAll('input[name="deductible_'+currentReviewIndex+'"]').forEach(e=>{
    e.addEventListener('change',()=>{
      document.getElementById('learn_'+currentReviewIndex).style.display='block';
    });
  });
  updateProgress();
}

function submitReview(){
  const e=document.querySelector('input[name="deductible_'+currentReviewIndex+'"]:checked');
  if(!e){
    alert('Please select an option');
    return;
  }
  const t=flaggedTransactions[currentReviewIndex];
  t.isDeductible=e.value==='yes';
  const a=document.getElementById('remember_'+currentReviewIndex);
  if(a&&a.checked){
    learnedPatterns[t.merchant]=t.isDeductible;
  }
  currentReviewIndex++;
  renderFlaggedTransactions();
}

function updateProgress(){
  const e=flaggedTransactions.length>0?currentReviewIndex/flaggedTransactions.length*100:100;
  document.getElementById('reviewProgress').style.width=e+'%';
}

function generateReport(){
  document.getElementById('step3').classList.add('hidden');
  document.getElementById('step4').classList.remove('hidden');
  const e=allTransactions.filter(e=>e.isDeductible);
  const t=e.reduce((e,t)=>e+t.amount,0);
  const a=[...new Set(allTransactions.map(e=>e.month))];
  document.getElementById('totalDeductible').textContent='$'+t.toFixed(2);
  document.getElementById('totalTransactions').textContent=allTransactions.length;
  document.getElementById('estimatedSavings').textContent='$'+(t*0.25).toFixed(2);
  document.getElementById('monthsCovered').textContent=a.length;
  renderRecurringPayments(e);
  renderMonthlyBreakdown(a);
}

function renderRecurringPayments(deductibleTransactions){
  const merchantData={};
  deductibleTransactions.forEach(t=>{
    const merchant=t.merchant;
    if(!merchantData[merchant]){
      merchantData[merchant]=[];
    }
    merchantData[merchant].push(t.amount);
  });
  const recurring=[];
  Object.entries(merchantData).forEach(([merchant,amounts])=>{
    if(amounts.length>=2){
      const avg=amounts.reduce((a,b)=>a+b,0)/amounts.length;
      const isConsistent=amounts.every(amt=>Math.abs(amt-avg)<=2);
      if(isConsistent){
        const total=amounts.reduce((a,b)=>a+b,0);
        recurring.push({merchant,count:amounts.length,total,avgAmount:avg});
      }
    }
  });
  recurring.sort((a,b)=>b.count-a.count);
  if(recurring.length>0){
    const container=document.getElementById('recurringSection');
    let html='<div style="margin-top:40px"><h2 style="font-size:18px;margin-bottom:20px;font-weight:normal">Recurring Payments</h2><div style="background:#111;padding:20px;border:1px solid #333">';
    recurring.forEach(item=>{
      html+='<div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #222"><span>'+item.merchant+'</span><span style="color:#999">'+item.count+'x @ ~$'+item.avgAmount.toFixed(2)+' • $'+item.total.toFixed(2)+'</span></div>';
    });
    html+='</div></div>';
    container.innerHTML=html;
  }else{
    document.getElementById('recurringSection').innerHTML='';
  }
}

function renderMonthlyBreakdown(e){
  const t=document.getElementById('monthlyBreakdown');
  t.innerHTML='';
  e.forEach(e=>{
    const a=allTransactions.filter(t=>t.month===e);
    const n=a.filter(e=>e.isDeductible);
    const r=n.reduce((e,t)=>e+t.amount,0);
    const s=document.createElement('div');
    s.className='month-section';
    let d='';
    n.forEach(e=>{
      d+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #222;font-size:12px"><span>'+e.date+' - '+e.merchant+'</span><span>$'+e.amount.toFixed(2)+'</span></div>';
    });
    s.innerHTML='<div class="month-header">'+e+'</div><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:15px"><span>'+a.length+' transactions</span><span>'+n.length+' deductible • $'+r.toFixed(2)+'</span></div>'+(n.length>0?'<div style="background:#000;padding:15px;border:1px solid #222">'+d+'</div>':'<div style="color:#666;font-size:12px">No deductible transactions this month</div>');
    t.appendChild(s);
  });
}

function downloadReport(){
  try{
    const e=allTransactions.map(e=>({
      Date:e.date,
      Month:e.month,
      Merchant:e.merchant,
      Amount:e.amount,
      Category:e.category,
      Deductible:e.isDeductible?'Yes':'No'
    }));
    const t=Papa.unparse(e);
    const a=new Blob([t],{type:'text/csv;charset=utf-8;'});
    const n=document.createElement('a');
    n.href=URL.createObjectURL(a);
    n.download='tax_report_'+new Date().toISOString().split('T')[0]+'.csv';
    document.body.appendChild(n);
    n.click();
    document.body.removeChild(n);
    setTimeout(()=>URL.revokeObjectURL(n.href),1000);
  }catch(e){
    console.error(e);
    alert('Download failed: '+e.message);
  }
}

async function downloadMonthly(){
  try{
    const e=new JSZip();
    const t=[...new Set(allTransactions.map(e=>e.month))];
    if(t.length===0){
      alert('No transactions to download');
      return;
    }
    t.forEach(t=>{
      const a=allTransactions.filter(e=>e.month===t&&e.isDeductible);
      if(a.length>0){
        const n=Papa.unparse(a.map(e=>({
          Date:e.date,
          Merchant:e.merchant,
          Amount:e.amount,
          Category:e.category
        })));
        e.file(t.replace(/\s/g,'_')+'_deductions.csv',n);
      }
    });
    const a=await e.generateAsync({type:'blob'});
    const n=document.createElement('a');
    n.href=URL.createObjectURL(a);
    n.download='monthly_reports_'+new Date().toISOString().split('T')[0]+'.zip';
    document.body.appendChild(n);
    n.click();
    document.body.removeChild(n);
    setTimeout(()=>URL.revokeObjectURL(n.href),1000);
  }catch(e){
    console.error(e);
    alert('Download failed: '+e.message);
  }
}

function resetTool(){
  location.reload();
}
</script>
</body>
</html>
